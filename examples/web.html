<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Open Chat Framework Dev</title>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>

    <style type="text/css">
    body {margin-top: 30px;}
    </style>

</head>

<body>

    <div class="container">
      <div class="row">
        <div class="col-lg-3">

            <div class="card">

                <div class="card-block">
                    <h4 class="card-title">Online</h4>
                    <p class="card-text">Your are <span id="me"></span></p>
                </div>

                <ul id="online-list" class="list-group list-group-flush">
                </ul>

            </div>

        </div>
        <div class="col-lg-9">
          

          <div id="chats" class="row">
          </div>

        </div>
      </div>
    </div>
    
    <script src="../web/ocf.js" type="text/javascript"></script>
    <script src="../plugins/typingIndicator.js" type="text/javascript"></script>
    <script type="text/javascript">

    OCF.config({
        globalChannel: 'ofc-tester-9' // global chan or root, namespace? organization
    }, [
        OCF.plugin.typingIndicator({
            timeout: 5000
        })
    ]);

    var username = location.search.split('username=')[1];

    let me = OCF.identify(username, {username: username});

    $('#me').text(me.data.state.username + ' with uuid: ' + me.data.uuid);

    let onlineList = function($el, chat) {

        var appendUser = function(user) {

            var $onlineUser = $('<li class="' + user.data.uuid + ' list-group-item"><a href="#">' + user.data.state.username  + '</a> <span class="show-typing">is typing...</span></li>');

            $onlineUser.find('a').click(() => {

                let newChat = new OCF.GroupChat();

                appendChat(newChat);
                user.direct.publish('private-invite', {channel: newChat.channel});

            });

            user.feed.emitter.on('starttyping', () => { 
                $onlineUser.find('.show-typing').show();
            })

            $onlineUser.find('.show-typing').hide();
            $el.append($onlineUser);

        };

        chat.emitter.on('join', (payload) => {
            appendUser(payload.user);
        });
        
        chat.emitter.on('leave', (payload) => {
            $('.' + payload.user.data.uuid).remove();
        });

    }

    let appendChat = function(privateChat) {

        var $privateChat = $('<div class="chat col-xs-12"><div class="card"><div class="card-block"><h3 class="title">'+privateChat.channel + '</h3></div><ul class="online-list-sub list-group list-group-flush"></ul><div class="card-block"><div class="log"></div><input type="text" class="message"><input type="submit" class="submit"><div class="typing"></div><a href="#" class="close">close</a></div></div></div>');

        onlineList($privateChat.find('.online-list-sub'), privateChat);

        $privateChat.find('.message').on('change keyup paste click blur', () => {
            privateChat.typing.startTyping();
        });

        $privateChat.find('.submit').click(() => {

            privateChat.typing.stopTyping();

            privateChat.publish('message', {
                text: $privateChat.find('.message').val()
            });

            $privateChat.find('.message').val('');

        });

        privateChat.emitter.on('message', (payload) => {
            $privateChat.find('.log').append($('<div><strong>' + payload.sender.data.state.username + ':</strong> ' + payload.data.text + '</div>'));
        });

        privateChat.emitter.on('startTyping', (payload) => {

            $privateChat.find('.typing').text(payload.sender.data.state.username + ' is typing...');
            $('.' + payload.sender.data.uuid).find('.show-typing').show();

        });

        privateChat.emitter.on('stopTyping', (payload) => {
            $privateChat.find('.typing').text('');
            $('.' + payload.sender.data.uuid).find('.show-typing').hide();
        });

        $privateChat.find('.close').click(() => {
            // disconnect
            $privateChat.remove();
        });

        $('#chats').append($privateChat);

    } 

    me.direct.emitter.on('private-invite', (payload) => {
        appendChat(new OCF.GroupChat(payload.data.channel));

    });

    let globalChat = OCF.getGlobalChat();

    onlineList($('#online-list'), globalChat);

    globalChat.emitter.on('message', (payload) => {
        console.log('got message', payload.sender, payload.data);
    });

    globalChat.emitter.on('ready', () => {

    });

  </script>
</body>
</html>
